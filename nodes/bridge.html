<script type="text/javascript">
// âœ… Usar Z2MDebug do contexto global (jÃ¡ carregado pelo api.html)
(function(win) {
    if (!win.Z2MDebug && win.parent && win.parent.Z2MDebug) {
        win.Z2MDebug = win.parent.Z2MDebug;
    }
})(window);
</script>

<style>
    .server-status-section {
        background: #fff;
        padding: 15px;
        border-radius: 6px;
        border: 2px solid #e0e0e0;
        margin-bottom: 20px;
    }

    .server-status-section.online {
        border-color: #66bb6a;
        background: #f1f8f4;
    }

    .server-status-section.offline,
    .server-status-section.mqtt-offline,
    .server-status-section.z2m-offline {
        border-color: #ef5350;
        background: #ffebee;
    }

    .server-status-title {
        font-size: 14px;
        font-weight: 600;
        margin-bottom: 10px;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .server-status-indicator {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        display: inline-block;
    }

    .server-status-indicator.online {
        background: #66bb6a;
        box-shadow: 0 0 6px rgba(102, 187, 106, 0.6);
    }

    .server-status-indicator.offline {
        background: #ef5350;
        box-shadow: 0 0 6px rgba(239, 83, 80, 0.6);
    }

    .server-status-details {
        font-size: 12px;
        color: #666;
        margin-top: 8px;
        line-height: 1.8;
    }

    .server-status-details strong {
        color: #333;
        font-weight: 600;
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    /* STATUS BADGES - SIMPLES */
    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .status-ok {
        color: #2e7d32;
        font-weight: 600;
    }

    .status-error {
        color: #c62828;
        font-weight: 600;
    }

    .status-warning {
        color: #e65100;
        font-weight: 600;
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    /* TABS - CORES SIMPLES */
    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .tab-button.error,
    .tab-button.mqtt-error,
    .tab-button.z2m-error {
        background: #ffebee;
        color: #c62828;
        border-color: #ef5350;
    }

    .tab-button.warning {
        background: #fff3e0;
        color: #e65100;
        border-color: #ff9800;
    }

    .tab-button.success {
        background: #e8f5e9;
        color: #2e7d32;
        border-color: #66bb6a;
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    /* REMOVER ANIMAÃ‡Ã•ES E TOOLTIPS */
    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

    /* Remover todas as animaÃ§Ãµes de pulse */
    @keyframes none {}

    .server-status-section.mqtt-offline,
    .server-status-section.z2m-offline {
        animation: none;
    }

    .server-status-indicator.online {
        animation: none;
    }

    /* Esconder tooltips/error boxes */
    .error-message-box,
    .component-error-badge {
        display: none !important;
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    /* STATUS GRID (mantida) */
    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .status-grid {
        display: grid;
        grid-template-columns: 180px 1fr;
        gap: 12px;
        font-size: 13px;
        background: #f9f9f9;
        padding: 15px;
        border-radius: 6px;
        border: 1px solid #e0e0e0;
    }

    .status-label {
        font-weight: 600;
        color: #555;
    }

    .status-value {
        font-family: 'Courier New', monospace;
        color: #333;
    }
    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    /* TAB SYSTEM */
    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .bridge-tabs {
        margin: 15px 0 20px 0;
        border-bottom: 2px solid #ddd;
        display: flex;
        gap: 4px;
    }
    
    .tab-button {
        background: #f5f5f5;
        border: 1px solid #ddd;
        border-bottom: none;
        padding: 10px 20px;
        cursor: pointer;
        border-radius: 6px 6px 0 0;
        font-size: 13px;
        font-weight: 500;
        transition: all 0.2s;
        position: relative;
    }
    
    .tab-button:hover {
        background: #e8e8e8;
    }
    
    .tab-button.active {
        background: white;
        font-weight: bold;
        border-bottom: 2px solid white;
        margin-bottom: -2px;
    }
    
    .tab-button.error {
        background: #ffebee;
        color: #c62828;
        border-color: #ef5350;
    }
    
    .tab-button.warning {
        background: #fff3e0;
        color: #e65100;
        border-color: #ff9800;
    }
    
    .tab-button.success {
        background: #e8f5e9;
        color: #2e7d32;
        border-color: #66bb6a;
    }
    
    .tab-content {
        display: none;
        padding: 20px 0;
        animation: fadeIn 0.3s;
    }
    
    .tab-content.active {
        display: block;
    }
    
    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }
    
    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    /* STATUS DISPLAY */
    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .server-status-section {
        background: #fff;
        padding: 15px;
        border-radius: 6px;
        border: 2px solid #e0e0e0;
        margin-bottom: 20px;
    }
    
    .server-status-section.online {
        border-color: #66bb6a;
        background: #f1f8f4;
    }
    
    .server-status-section.offline {
        border-color: #ef5350;
        background: #ffebee;
    }
    
    .server-status-title {
        font-size: 14px;
        font-weight: 600;
        margin-bottom: 10px;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .server-status-indicator {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        display: inline-block;
    }
    
    .server-status-indicator.online {
        background: #66bb6a;
        box-shadow: 0 0 6px rgba(102, 187, 106, 0.6);
        animation: pulse 2s infinite;
    }
    
    .server-status-indicator.offline {
        background: #ef5350;
        box-shadow: 0 0 6px rgba(239, 83, 80, 0.6);
    }
    
    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
    }
    
    .server-status-details {
        font-size: 12px;
        color: #666;
        margin-top: 8px;
        line-height: 1.6;
    }
    
    .server-status-details strong {
        color: #333;
        font-weight: 600;
    }
    
    .status-grid {
        display: grid;
        grid-template-columns: 180px 1fr;
        gap: 12px;
        font-size: 13px;
        background: #f9f9f9;
        padding: 15px;
        border-radius: 6px;
        border: 1px solid #e0e0e0;
    }
    
    .status-label {
        font-weight: 600;
        color: #555;
    }
    
    .status-value {
        font-family: 'Courier New', monospace;
        color: #333;
    }
    
    .status-ok { color: #2e7d32; font-weight: bold; }
    .status-error { color: #c62828; font-weight: bold; }
    .status-warning { color: #e65100; font-weight: bold; }
    
    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    /* PERMIT JOIN SECTION */
    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .permit-join-container {
        background: #f5f5f5;
        padding: 15px;
        border-radius: 6px;
        border: 1px solid #ddd;
    }
    
    .permit-join-buttons {
        display: flex;
        gap: 8px;
        margin-bottom: 12px;
    }
    
    .permit-join-time-input {
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    #node-input-permitjoin-time {
        width: 100px;
        padding: 6px 10px;
        font-size: 14px;
        border: 1px solid #ccc;
        border-radius: 4px;
    }
    
    .time-display {
        color: #666;
        font-size: 12px;
        font-weight: 500;
    }
    
    .red-ui-button:disabled,
    .red-ui-button.disabled {
        opacity: 0.5;
        cursor: not-allowed;
        pointer-events: none;
    }
    
    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    /* DEVICES/GROUPS TABLE */
    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .z2m-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 12px;
    }
    
    .z2m-table th {
        background: #f5f5f5;
        padding: 10px;
        text-align: left;
        font-weight: 600;
        border-bottom: 2px solid #ddd;
        cursor: pointer;
        user-select: none;
        position: relative;
    }
    
    .z2m-table th:hover {
        background: #e8e8e8;
    }
    
    .z2m-table th.sortable::after {
        content: ' â‡…';
        color: #999;
        font-size: 10px;
    }
    
    .z2m-table th.sorted-asc::after {
        content: ' â†‘';
        color: #333;
    }
    
    .z2m-table th.sorted-desc::after {
        content: ' â†“';
        color: #333;
    }
    
    .z2m-table td {
        padding: 8px 10px;
        border-bottom: 1px solid #eee;
        vertical-align: middle;
    }
    
    .z2m-table tr:hover {
        background: #f9f9f9;
    }
    
    .z2m-table th.status-col {
        width: 50px;
        text-align: center;
        cursor: default;
    }
    
    .z2m-table th.status-col::after {
        content: none;
    }
    
    .z2m-table td.status-col {
        text-align: center;
        font-size: 16px;
    }
    
    .device-status-online {
        color: #2e7d32;
        cursor: default;
    }
    
    .device-status-offline {
        color: #c62828;
        cursor: default;
    }
    
    .device-status-warning {
        color: #e65100;
        cursor: default;
    }
    
    .device-status-interview {
        color: #2196f3;
        cursor: pointer;
        transition: all 0.2s;
    }
    
    .device-status-interview:hover {
        color: #1976d2;
        transform: scale(1.2);
    }
    
    .device-status-disabled {
        color: #9e9e9e;
        cursor: default;
    }
    
    .device-status-not-supported {
        color: #ff9800;
        cursor: default;
    }
    
    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    /* COMMON STYLES */
    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .l-width {
        width: 150px;
    }
    
    .s-width {
        width: 150px;
    }
    
    .form-tips {
        padding: 10px;
        background: #e3f2fd;
        border-left: 4px solid #2196f3;
        border-radius: 4px;
        margin-bottom: 15px;
    }
    
    .node-input-devices-friendly_name, .node-input-groups-friendly_name {
        width: 100% !important;
        min-width: 200px !important;
    }
</style>

<link rel="stylesheet" href="resources/node-red-contrib-zigbee2mqtt/tokeninput/token-input-facebook.css" type="text/css" />
<script type='text/javascript'>
    $.getScript('resources/node-red-contrib-zigbee2mqtt/tokeninput/jquery.tokeninput.js');
</script>

<script type="text/x-red" data-template-name="zigbee2mqtt-bridge">
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-bookmark"></i> <span data-i18n="label.name"></span></label>
        <input type="text" id="node-input-name" data-i18n="[placeholder]placeholder.name">
    </div>
    
    <div class="form-row">
        <label for="node-input-server"><i class="fa fa-globe"></i> <span data-i18n="label.server"></span></label>
        <input type="text" id="node-input-server">
    </div>

    <div class="bridge-tabs">
        <button class="tab-button active" data-tab="bridge" type="button">
            <i class="fa fa-cog"></i> Bridge
        </button>
        <button class="tab-button" data-tab="status" id="tab-status" type="button">
            <i class="fa fa-info-circle"></i> Status
        </button>
        <button class="tab-button" data-tab="devices" id="tab-devices" type="button">
            <i class="fa fa-lightbulb-o"></i> Devices
        </button>
        <button class="tab-button" data-tab="groups" id="tab-groups" type="button">
            <i class="fa fa-object-group"></i> Groups
        </button>
        <button class="tab-button" data-tab="map" id="tab-map" type="button">
            <i class="fa fa-sitemap"></i> Map
        </button>
    </div>

    <div class="tab-content active" id="content-bridge">
        <div class="form-row">
            <label for="refresh-all" class="l-width">
                <i class="fa fa-refresh"></i> <span data-i18n="label.refresh"></span>
            </label>
            <a class="red-ui-button s-width" id="refresh-all">
                <span data-i18n="label.refresh_all"></span>
            </a>
        </div>
        
        <div class="form-row">
            <label class="l-width">
                <i class="fa fa-sign-in"></i> Permit Join
            </label>
            <div class="permit-join-container" style="display: inline-block; width: 70%;">
                <div class="permit-join-buttons">
                    <a class="red-ui-button" id="permit-join-start">
                        <i class="fa fa-play"></i> <span data-i18n="label.permit_join_help"></span>
                    </a>
                    <a class="red-ui-button" id="permit-join-stop" style="display:none;">
                        <i class="fa fa-stop"></i> <span data-i18n="label.permit_join_cancel_help"></span>
                    </a>
                </div>
                <div class="permit-join-time-input">
                    <input type="number" 
                           id="node-input-permitjoin-time" 
                           value="180" 
                           min="10" 
                           max="3600" 
                           step="30">
                    <span class="time-display">
                        seconds (<span id="permit-join-time-formatted">3 min</span>)
                    </span>
                </div>
            </div>
        </div>
        
        <div class="form-row">
            <label for="log-level" class="l-width">
                <i class="fa fa-commenting-o"></i> <span data-i18n="label.log_level"></span>
            </label>
            <button style="width: 17%" class="red-ui-button log-level-btn" data-level="info" id="log-level-info-btn" type="button">
                <span data-i18n="label.log_level_info"></span>
            </button>
            <button style="width: 17%" class="red-ui-button log-level-btn" data-level="debug" id="log-level-debug-btn" type="button">
                <span data-i18n="label.log_level_debug"></span>
            </button>
            <button style="width: 17%" class="red-ui-button log-level-btn" data-level="warning" id="log-level-warning-btn" type="button">
                <span data-i18n="label.log_level_warning"></span>
            </button>
            <button style="width: 17%" class="red-ui-button log-level-btn" data-level="error" id="log-level-error-btn" type="button">
                <span data-i18n="label.log_level_error"></span>
            </button>
        </div>
        
        <div class="form-row">
            <label for="restart-bridge" class="l-width">
                <i class="fa fa-power-off"></i> <span data-i18n="label.restart"></span>
            </label>
            <button style="width: 70%" class="red-ui-button" id="restart-bridge" type="button">
                <span data-i18n="label.restart_zigbee2mqtt"></span>
            </button>
        </div>
    </div>

    <div class="tab-content" id="content-status">
        <div class="server-status-section" id="server-connection-status">
            <div class="server-status-title">
                <span class="server-status-indicator" id="server-indicator"></span>
                <span id="server-status-text">Checking server connection...</span>
            </div>
            <div class="server-status-details" id="server-status-details"></div>
        </div>
        
        <div class="status-grid" id="status-display">
            <div class="status-label">Coordinator:</div>
            <div class="status-value" id="status-coordinator">Loading...</div>
            
            <div class="status-label">Advanced Output:</div>
            <div class="status-value" id="status-advanced-output">Loading...</div>
            
            <div class="status-label">Legacy API:</div>
            <div class="status-value" id="status-legacy-api">Loading...</div>
            
            <div class="status-label">MQTT Retain:</div>
            <div class="status-value" id="status-mqtt-retain">Loading...</div>
            
            <div class="status-label">Permit Join:</div>
            <div class="status-value" id="status-permit-join">Loading...</div>
            
            <div class="status-label">Restart Required:</div>
            <div class="status-value" id="status-restart-required">Loading...</div>
            
            <div class="status-label">Log Level:</div>
            <div class="status-value" id="status-log-level">Loading...</div>
            
            <div class="status-label">Devices Count:</div>
            <div class="status-value" id="status-devices-count">Loading...</div>
            
            <div class="status-label">Groups Count:</div>
            <div class="status-value" id="status-groups-count">Loading...</div>
        </div>
    </div>

    <div class="tab-content" id="content-devices">
        <div class="form-tips" id="devices-status">
            <i class="fa fa-spinner fa-spin"></i> Loading devices...
        </div>
        <table class="z2m-table" id="devices-table" style="display:none;">
            <thead>
                <tr>
                    <th class="status-col">
                        <i class="fa fa-circle"></i>
                    </th>
                    <th class="sortable" data-sort="friendly_name" style="width:200px;">
                        <span data-i18n="devices.friendly_name"></span>
                    </th>
                    <th class="sortable" data-sort="ieee_address" style="width:auto;">
                        <span data-i18n="devices.device"></span>
                    </th>
                    <th class="sortable" data-sort="model" style="width:150px;">
                        Model
                    </th>
                    <th style="width:80px;"></th>
                    <th style="width:80px;"></th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <div class="tab-content" id="content-groups">
        <div class="form-row">
            <a href="#" class="red-ui-button" id="add-group-btn">
                <i class="fa fa-plus"></i>&nbsp;<span data-i18n="groups.add"></span>
            </a>
        </div>
        <div class="form-tips" id="groups-status">
            <i class="fa fa-spinner fa-spin"></i> Loading groups...
        </div>
        <table class="z2m-table" id="groups-table" style="display:none;">
            <thead>
                <tr>
                    <th class="status-col">
                        <i class="fa fa-circle"></i>
                    </th>
                    <th class="sortable" data-sort="friendly_name" style="width:200px;">
                        <span data-i18n="groups.friendly_name"></span>
                    </th>
                    <th style="width:auto;">Members</th>
                    <th style="width:80px;"></th>
                    <th style="width:80px;"></th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <div class="tab-content" id="content-map">
        <div class="form-row">
            <a href="#" id="refresh-map-btn" class="red-ui-button">
                <i class="fa fa-refresh"></i>&nbsp;<span data-i18n="map.refresh"></span>
            </a>
            <a href="#" id="fullscreen-map-btn" class="red-ui-button" style="display:none; margin-left: 10px;">
                <i class="fa fa-external-link"></i>&nbsp;<span data-i18n="map.fullscreen"></span>
            </a>
        </div>
        <div id="map-display" style="text-align: center; padding: 20px; border: 1px solid #ddd; border-radius: 6px; background: #fafafa;">
            <i class="fa fa-sitemap" style="font-size: 48px; color: #ccc;"></i>
            <p style="color: #999; margin-top: 10px;">Click "Refresh" to load network map</p>
        </div>
        <select id="node-input-engine" style="width:100px;display:none;">
            <option value="circo" selected>circo</option>
            <option value="dot">dot</option>
            <option value="fdp">fdp</option>
            <option value="neato">neato</option>
            <option value="osage">osage</option>
            <option value="twopi">twopi</option>
        </select>
    </div>
</script>

<script type='text/javascript'>
RED.nodes.registerType('zigbee2mqtt-bridge', {
    category: 'Zigbee2mqtt',
    color: '#FDBF48',
    defaults: {
        name: { value: "" },
        server: { type: "zigbee2mqtt-server", required: true },
        permitjoin_time: { value: 180 }
    },
    inputs: 1,
    outputs: 1,
    paletteLabel: 'bridge',
    icon: "icon.png",
    label: function() {
        return this.name || 'Zigbee2mqtt Bridge';
        },
   
    oneditprepare: function() {
        const node = this;
        const debug = Z2MDebug.create('Z2M Bridge');
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // VARIÃVEIS GLOBAIS
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        let permitJoinTimeout = null;
        let devicesData = [];
        let groupsData = [];
        let hasMapData = false;
        let isOnline = false; // â† Estado Ãºnico e simples
        let stateCheckInterval = null;
        
        node._z2m_stateCheckInterval = null;
        let serverState = {
            online: false,
            state: 'unknown',        // 'online', 'mqtt_offline', 'z2m_offline', 'unknown'
            errorComponent: null,    // null, 'mqtt', 'zigbee2mqtt', 'unknown'
            mqtt: null,
            zigbee2mqtt: null,
            stats: null
        };
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // FUNÃ‡ÃƒO: Detectar Estado (SIMPLES)
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function detectServerState(serverId, callback) {
            debug.log('ğŸ” Calling API /zigbee2mqtt/serverState/' + serverId);
            
            const apiUrl = 'zigbee2mqtt/serverState/' + serverId;
            
            $.getJSON(apiUrl)
                .done(function(data) {
                    debug.log('âœ… API Response:', data);
                    
                    if (!data) {
                        debug.warn('âš ï¸ Empty response from API');
                        callback({
                            online: false,
                            state: 'unknown',
                            errorComponent: 'unknown'
                        });
                        return;
                    }
                    
                    // âœ… Guardar estado completo
                    const newState = {
                        online: data.online === true,
                        state: data.state || 'unknown',
                        errorComponent: data.errorComponent || null,
                        mqtt: data.mqtt || null,
                        zigbee2mqtt: data.zigbee2mqtt || null,
                        stats: data.stats || null
                    };
                    
                    debug.log('ğŸ“Š Server state:', newState.state);
                    if (!newState.online && newState.errorComponent) {
                        debug.warn('âš ï¸ Component failed:', newState.errorComponent);
                    }
                    
                    callback(newState);
                })
                .fail(function(xhr, status, error) {
                    debug.error('âŒ API call failed');
                    debug.error('  - Status:', status);
                    debug.error('  - Error:', error);
                    
                    callback({
                        online: false,
                        state: 'api_error',
                        errorComponent: 'api'
                    });
                });
        }
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // FUNÃ‡ÃƒO: Monitoramento (2s)
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function startStateMonitoring() {
            const currentServer = $('#node-input-server').val();
            
            if (!currentServer || currentServer === '_ADD_' || currentServer === '') {
                debug.log('âš ï¸ Cannot start monitoring: no server selected');
                return;
            }
            
            // âœ… Parar qualquer monitoramento anterior
            stopStateMonitoring();
            
            debug.log('â–¶ï¸ Starting state monitoring for server:', currentServer);
            
            // âœ… CRIAR INTERVALO
            stateCheckInterval = setInterval(function() {
                // âœ… Detectar estado atual
                detectServerState(currentServer, function(newState) {
                    // âœ… Comparar estado
                    const stateChanged = newState.state !== serverState.state;
                    const errorChanged = newState.errorComponent !== serverState.errorComponent;
                    
                    if (stateChanged || errorChanged) {
                        debug.log('ğŸ”„ State changed:', serverState.state, 'â†’', newState.state);
                        if (newState.errorComponent) {
                            debug.warn('âš ï¸ Error component:', newState.errorComponent);
                        }
                        
                        // âœ… Atualizar estado global
                        serverState = newState;
                        
                        // âœ… Atualizar UI
                        updateUIState();
                    }
                });
            }, 2000); // A cada 2 segundos
            
            // âœ… Guardar referÃªncia
            node._z2m_stateCheckInterval = stateCheckInterval;
            
            debug.log('âœ… Monitoring started, interval ID:', stateCheckInterval);
        }
        function stopStateMonitoring() {
            if (stateCheckInterval) {
                debug.log('â¹ï¸ Stopping monitoring, interval ID:', stateCheckInterval);
                clearInterval(stateCheckInterval);
                stateCheckInterval = null;
                node._z2m_stateCheckInterval = null;
            }
        }
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // FUNÃ‡ÃƒO: Atualizar UI baseado no estado
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function updateUIState() {
            const currentServer = $('#node-input-server').val();
            const hasServer = currentServer && currentServer !== '_ADD_' && currentServer !== '';
            
            // CASO 1: Sem servidor configurado
            if (!hasServer) {
                $('#server-connection-status')
                    .removeClass('online offline mqtt-offline z2m-offline')
                    .css({ 'border-color': '#bdbdbd', 'background': '#fafafa' });
                $('#server-indicator').removeClass('online offline').css('background', '#bdbdbd');
                $('#server-status-text').html(
                    '<strong>' + RED._("node-red-contrib-zigbee2mqtt/bridge:status.no_server_configured") + '</strong>'
                );
                $('#server-status-details').html(
                    '<span style="color: #757575;">' + RED._("node-red-contrib-zigbee2mqtt/bridge:status.select_server_begin") + '</span>'
                );
                
                $('#tab-status, #tab-devices, #tab-groups, #tab-map').removeClass('success warning error mqtt-error z2m-error');
                setControlsEnabled(false);
                return;
            }
            
            const serverInfo = getServerInfo(currentServer);
            
            // CASO 2: Tudo ONLINE âœ”
            if (serverState.state === 'online') {
                $('#server-connection-status')
                    .removeClass('offline mqtt-offline z2m-offline')
                    .addClass('online');
                $('#server-indicator').removeClass('offline').addClass('online');
                $('#server-status-text').html(
                    '<strong>âœ” ' + RED._("node-red-contrib-zigbee2mqtt/bridge:status.all_systems_online") + '</strong>'
                );
                
                const mqttHost = serverState.mqtt?.host || 'Unknown';
                const mqttPort = serverState.mqtt?.port || '1883';
                const z2mVersion = serverState.zigbee2mqtt?.version || 'Unknown';
                const baseTopic = serverState.zigbee2mqtt?.base_topic || 'zigbee2mqtt';
                
                $('#server-status-details').html(
                    '<strong>' + RED._("node-red-contrib-zigbee2mqtt/bridge:server_info.server") + ':</strong> ' + (serverInfo?.name || 'Z2M') + '<br>' +
                    '<strong>' + RED._("node-red-contrib-zigbee2mqtt/bridge:server_info.mqtt_broker") + ':</strong> ' +
                    '<span style="color: #2e7d32;">' + mqttHost + ':' + mqttPort + '</span> ' +
                    '<span class="status-ok">' + RED._("node-red-contrib-zigbee2mqtt/bridge:server_info.connected") + '</span><br>' +
                    '<strong>' + RED._("node-red-contrib-zigbee2mqtt/bridge:server_info.zigbee2mqtt") + ':</strong> ' +
                    '<span style="color: #1976d2;">' + RED._("node-red-contrib-zigbee2mqtt/bridge:server_info.version") + z2mVersion + '</span> ' +
                    '<span class="status-ok">' + RED._("node-red-contrib-zigbee2mqtt/bridge:status.online") + '</span><br>' +
                    '<strong>' + RED._("node-red-contrib-zigbee2mqtt/bridge:server_info.base_topic") + ':</strong> ' + baseTopic
                );
                
                $('#tab-status').removeClass('warning error mqtt-error z2m-error').addClass('success');
                
                if (devicesData.length > 0) $('#tab-devices').removeClass('warning error').addClass('success');
                else $('#tab-devices').removeClass('warning error success');
                
                if (groupsData.length > 0) $('#tab-groups').removeClass('warning error').addClass('success');
                else $('#tab-groups').removeClass('warning error success');
                
                if (hasMapData) $('#tab-map').removeClass('warning error').addClass('success');
                else $('#tab-map').removeClass('warning error success');
                
                setControlsEnabled(true);
            }
            
            // CASO 3: MQTT OFFLINE âœ˜
            else if (serverState.state === 'mqtt_offline') {
                $('#server-connection-status')
                    .removeClass('online z2m-offline')
                    .addClass('offline mqtt-offline');
                $('#server-indicator').removeClass('online').addClass('offline');
                $('#server-status-text').html(
                    '<strong>âœ˜ ' + RED._("node-red-contrib-zigbee2mqtt/bridge:status.mqtt_offline") + '</strong>'
                );
                
                const mqttHost = serverState.mqtt?.host || 'Unknown';
                const mqttPort = serverState.mqtt?.port || '1883';
                
                $('#server-status-details').html(
                    '<strong>' + RED._("node-red-contrib-zigbee2mqtt/bridge:server_info.server") + ':</strong> ' + (serverInfo?.name || 'Z2M') + '<br>' +
                    '<strong>' + RED._("node-red-contrib-zigbee2mqtt/bridge:server_info.mqtt_broker") + ':</strong> ' +
                    '<span style="color: #c62828;">' + mqttHost + ':' + mqttPort + '</span> ' +
                    '<span class="status-error">' + RED._("node-red-contrib-zigbee2mqtt/bridge:status.mqtt_disconnected") + '</span><br>' +
                    '<strong>' + RED._("node-red-contrib-zigbee2mqtt/bridge:server_info.zigbee2mqtt") + ':</strong> ' +
                    '<span style="color: #999;">' + RED._("node-red-contrib-zigbee2mqtt/bridge:server_info.cannot_reach") + '</span>'
                );
                
                $('#tab-status').removeClass('success warning z2m-error').addClass('error mqtt-error');
                
                if (devicesData.length > 0) $('#tab-devices').removeClass('success error').addClass('warning');
                else $('#tab-devices').removeClass('success warning').addClass('error');
                
                if (groupsData.length > 0) $('#tab-groups').removeClass('success error').addClass('warning');
                else $('#tab-groups').removeClass('success warning').addClass('error');
                
                if (hasMapData) $('#tab-map').removeClass('success error').addClass('warning');
                else $('#tab-map').removeClass('success warning').addClass('error');
                
                setControlsEnabled(false);
            }
            
            // CASO 4: ZIGBEE2MQTT OFFLINE âš 
            else if (serverState.state === 'z2m_offline') {
                $('#server-connection-status')
                    .removeClass('online mqtt-offline')
                    .addClass('offline z2m-offline');
                $('#server-indicator').removeClass('online').addClass('offline');
                $('#server-status-text').html(
                    '<strong>âš  ' + RED._("node-red-contrib-zigbee2mqtt/bridge:status.z2m_offline") + '</strong>'
                );
                
                const mqttHost = serverState.mqtt?.host || 'Unknown';
                const mqttPort = serverState.mqtt?.port || '1883';
                const baseTopic = serverState.zigbee2mqtt?.base_topic || 'zigbee2mqtt';
                
                $('#server-status-details').html(
                    '<strong>' + RED._("node-red-contrib-zigbee2mqtt/bridge:server_info.server") + ':</strong> ' + (serverInfo?.name || 'Z2M') + '<br>' +
                    '<strong>' + RED._("node-red-contrib-zigbee2mqtt/bridge:server_info.mqtt_broker") + ':</strong> ' +
                    '<span style="color: #2e7d32;">' + mqttHost + ':' + mqttPort + '</span> ' +
                    '<span class="status-ok">' + RED._("node-red-contrib-zigbee2mqtt/bridge:server_info.connected") + '</span><br>' +
                    '<strong>' + RED._("node-red-contrib-zigbee2mqtt/bridge:server_info.zigbee2mqtt") + ':</strong> ' +
                    '<span style="color: #e65100;">' + RED._("node-red-contrib-zigbee2mqtt/bridge:status.z2m_not_responding") + '</span> ' +
                    '<span class="status-error">' + RED._("node-red-contrib-zigbee2mqtt/bridge:status.offline") + '</span><br>' +
                    '<strong>' + RED._("node-red-contrib-zigbee2mqtt/bridge:server_info.expected_topic") + ':</strong> ' + baseTopic
                );
                
                $('#tab-status').removeClass('success warning mqtt-error').addClass('error z2m-error');
                
                if (devicesData.length > 0) $('#tab-devices').removeClass('success error').addClass('warning');
                else $('#tab-devices').removeClass('success warning').addClass('error');
                
                if (groupsData.length > 0) $('#tab-groups').removeClass('success error').addClass('warning');
                else $('#tab-groups').removeClass('success warning').addClass('error');
                
                if (hasMapData) $('#tab-map').removeClass('success error').addClass('warning');
                else $('#tab-map').removeClass('success warning').addClass('error');
                
                setControlsEnabled(false);
            }
            
            // CASO 5: Estado desconhecido
            else {
                $('#server-connection-status')
                    .removeClass('online mqtt-offline z2m-offline')
                    .addClass('offline');
                $('#server-indicator').removeClass('online').addClass('offline');
                $('#server-status-text').html(
                    '<strong>? ' + RED._("node-red-contrib-zigbee2mqtt/bridge:status.unknown_state") + '</strong>'
                );
                
                $('#server-status-details').html(
                    '<strong>' + RED._("node-red-contrib-zigbee2mqtt/bridge:server_info.server") + ':</strong> ' + (serverInfo?.name || 'Z2M') + '<br>' +
                    '<span style="color: #999;">' + RED._("node-red-contrib-zigbee2mqtt/bridge:status.unable_to_determine") + '</span>'
                );
                
                $('#tab-status').removeClass('success warning mqtt-error z2m-error').addClass('error');
                $('#tab-devices').removeClass('success warning').addClass('error');
                $('#tab-groups').removeClass('success warning').addClass('error');
                $('#tab-map').removeClass('success warning').addClass('error');
                
                setControlsEnabled(false);
            }
        }
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // FUNÃ‡ÃƒO: Habilitar/Desabilitar controles
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function setControlsEnabled(enabled) {
            if (enabled) {
                $('#refresh-all').removeClass('disabled');
                $('#permit-join-start').removeClass('disabled');
                $('#permit-join-stop').removeClass('disabled');
                $('.log-level-btn').prop('disabled', false);
                $('#restart-bridge').prop('disabled', false);
                $('#node-input-permitjoin-time').prop('disabled', false);
                $('#add-group-btn').removeClass('disabled');
                $('#refresh-map-btn').removeClass('disabled');
            } else {
                $('#refresh-all').addClass('disabled');
                $('#permit-join-start').addClass('disabled');
                $('#permit-join-stop').addClass('disabled');
                $('.log-level-btn').prop('disabled', true);
                $('#restart-bridge').prop('disabled', true);
                $('#node-input-permitjoin-time').prop('disabled', true);
                $('#add-group-btn').addClass('disabled');
                $('#refresh-map-btn').addClass('disabled');
            }
        }
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // FUNÃ‡ÃƒO: Obter info do servidor
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function getServerInfo(serverId) {
            const serverNode = RED.nodes.node(serverId);
            if (!serverNode) return null;
            
            return {
                name: serverNode.name || 'Unnamed Server',
                broker: serverNode.broker || 'Unknown',
                port: serverNode.port || '1883',
                clientid: serverNode.clientid || 'Unknown',
                base_topic: serverNode.base_topic || 'zigbee2mqtt'
            };
        }
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // FUNÃ‡ÃƒO: Limpar todas as tabelas
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function clearAllTables() {
            $('#devices-table').hide().find('tbody').empty();
            $('#devices-status').html(
                '<span style="color: #999;">âš  ' + RED._("node-red-contrib-zigbee2mqtt/bridge:status.no_server_configured") + '</span>'
            );
            
            $('#groups-table').hide().find('tbody').empty();
            $('#groups-status').html(
                '<span style="color: #999;">âš  ' + RED._("node-red-contrib-zigbee2mqtt/bridge:status.no_server_configured") + '</span>'
            );
            
            $('#status-coordinator, #status-advanced-output, #status-legacy-api, #status-mqtt-retain, #status-permit-join, #status-restart-required, #status-log-level, #status-devices-count, #status-groups-count').text('â€“');
            
            $('#map-display').html(
                '<i class="fa fa-sitemap" style="font-size: 48px; color: #ccc;"></i>' +
                '<p style="color: #999; margin-top: 10px;">' + RED._("node-red-contrib-zigbee2mqtt/bridge:map.no_server_configured") + '</p>'
            );
            $('#fullscreen-map-btn').hide();
        }
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // FUNÃ‡ÃƒO: Formatar tempo
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function formatTime(seconds) {
            const h = Math.floor(seconds / 3600);
            const m = Math.floor((seconds % 3600) / 60);
            const s = seconds % 60;
            
            let parts = [];
            if (h > 0) parts.push(h + ' h');
            if (m > 0) parts.push(m + ' min');
            if (s > 0 || parts.length === 0) parts.push(s + ' s');
            
            return parts.join(' ');
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // FUNÃ‡ÃƒO INIT - CHAMADA UMA ÃšNICA VEZ
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function init() {
            const currentServer = $('#node-input-server').val();
            
            debug.log('ğŸš€ init() called with server:', currentServer);

            if (!currentServer || currentServer === '_ADD_' || currentServer === '') {
                debug.warn('âš ï¸ No valid server');
                serverState = {
                    online: false,
                    state: 'not_configured',
                    errorComponent: null
                };
                clearAllTables();
                updateUIState();
                return;
            }
            
            // âœ… Detectar estado inicial
            detectServerState(currentServer, function(state) {
                serverState = state;
                debug.log('ğŸ“¡ Initial server state:', serverState.state);
                
                // âœ… Carregar dados
                $.getJSON('zigbee2mqtt/getDevices', {
                    controllerID: currentServer
                }).done(function(data) {
                    if (data && data[0] && data[1]) {
                        devicesData = data[0].filter(d => d.type !== "Coordinator");
                        groupsData = data[1];
                        debug.log('âœ… Data loaded:', { devices: devicesData.length, groups: groupsData.length });
                    } else {
                        devicesData = [];
                        groupsData = [];
                        debug.warn('âš ï¸ No data returned');
                    }
                    updateUIState();
                }).fail(function() {
                    debug.error('âŒ Failed to load data');
                    devicesData = [];
                    groupsData = [];
                    updateUIState();
                });
            });
            
            // âœ… Carregar config se online
            if (serverState.state === 'online') {
                $.getJSON('zigbee2mqtt/getConfig', {
                    controllerID: currentServer,
                    permit_join: true
                }).done(function(data) {
                    if (data && data.log_level) {
                        $('.log-level-btn').removeClass('active');
                        $(`#log-level-${data.log_level}-btn`).addClass('active');
                    }
                    
                    if (data && data.permit_join) {
                        $('#permit-join-start').hide();
                        $('#permit-join-stop').show();
                    } else {
                        $('#permit-join-start').show();
                        $('#permit-join-stop').hide();
                    }
                });
            }
        }      
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // EVENT HANDLERS - Setup inicial
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        // Permit Join Time - FormataÃ§Ã£o
        if (node.permitjoin_time) {
            $('#node-input-permitjoin-time').val(node.permitjoin_time);
        }

        $('#node-input-permitjoin-time').on('input change', function() {
            const seconds = parseInt($(this).val()) || 180;
            $('#permit-join-time-formatted').text(formatTime(seconds));
        });

        $('#node-input-permitjoin-time').trigger('change');
        
        // MudanÃ§a de servidor
        $('#node-input-server').off('change').on('change', function() {
            debug.log('ğŸ”„ Server changed');
            init(); // â† Ãšnica reinicializaÃ§Ã£o permitida
        });
        
        // Refresh All
        $('#refresh-all').off('click').on('click', function() {
            // âœ… CORRIGIDO: Usar serverState.state
            if (serverState.state !== 'online') {
                RED.notify('Cannot refresh: server is offline', 'warning');
                return;
            }
            debug.log('ğŸ”„ Refresh all clicked');
            init();
        });
        
        // Trocar de aba - SEM reinicializar!
        $('.tab-button').off('click').on('click', function() {
            const tab = $(this).data('tab');
            
            $('.tab-button').removeClass('active');
            $(this).addClass('active');
            
            $('.tab-content').removeClass('active');
            $(`#content-${tab}`).addClass('active');
            
            // Carregar dados da aba se necessÃ¡rio
            const currentServer = $('#node-input-server').val();
            if (!currentServer || currentServer === '_ADD_' || currentServer === '') return;
            
            if (tab === 'status') loadStatus();
            else if (tab === 'devices') loadDevices();
            else if (tab === 'groups') loadGroups();
        });
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // PERMIT JOIN
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // PERMIT JOIN START
        $('#permit-join-start').off('click').on('click', function() {
            if (serverState.state !== 'online') {
                RED.notify(RED._("node-red-contrib-zigbee2mqtt/bridge:notifications.server_offline"), 'warning');
                return;
            }
            
            const currentServer = $('#node-input-server').val();
            const time = parseInt($('#node-input-permitjoin-time').val()) || 180;
            
            clearTimeout(permitJoinTimeout);
            
            $('#permit-join-start').hide();
            $('#permit-join-stop').show();
            
            $.getJSON('zigbee2mqtt/setPermitJoin', {
                controllerID: currentServer,
                permit_join: true,
                time: time
            }).done(function(data) {
                RED.notify(
                    RED._("node-red-contrib-zigbee2mqtt/bridge:notifications.permit_join_enabled")
                        .replace('{time}', time),
                    'success'
                );
                
                permitJoinTimeout = setTimeout(function() {
                    $('#permit-join-start').show();
                    $('#permit-join-stop').hide();
                }, time * 1000);
                
            }).fail(function() {
                RED.notify(RED._("node-red-contrib-zigbee2mqtt/bridge:notifications.failed_permit_join"), 'error');
                $('#permit-join-start').show();
                $('#permit-join-stop').hide();
            });
        });

        // PERMIT JOIN STOP
        $('#permit-join-stop').off('click').on('click', function() {
            if (serverState.state !== 'online') {
                RED.notify(RED._("node-red-contrib-zigbee2mqtt/bridge:notifications.server_offline"), 'warning');
                return;
            }
            
            const currentServer = $('#node-input-server').val();
            
            clearTimeout(permitJoinTimeout);
            
            $('#permit-join-start').show();
            $('#permit-join-stop').hide();
            
            $.getJSON('zigbee2mqtt/setPermitJoin', {
                controllerID: currentServer,
                permit_join: false
            }).done(function(data) {
                RED.notify(RED._("node-red-contrib-zigbee2mqtt/bridge:notifications.permit_join_disabled"), 'success');
            }).fail(function() {
                RED.notify(RED._("node-red-contrib-zigbee2mqtt/bridge:notifications.failed_cancel_permit"), 'error');
            });
        });
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // LOG LEVEL
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        $('.log-level-btn').off('click').on('click', function() {
            if (serverState.state !== 'online') {
                RED.notify(RED._("node-red-contrib-zigbee2mqtt/bridge:notifications.server_offline"), 'warning');
                return;
            }
            
            const currentServer = $('#node-input-server').val();
            const level = $(this).data('level');
            
            $('.log-level-btn').removeClass('active');
            $(this).addClass('active');
            
            $.getJSON('zigbee2mqtt/setLogLevel', {
                controllerID: currentServer,
                log_level: level
            }).done(function(data) {
                RED.notify(
                    RED._("node-red-contrib-zigbee2mqtt/bridge:notifications.log_level_set")
                        .replace('{level}', level),
                    'success'
                );
            }).fail(function() {
                RED.notify(RED._("node-red-contrib-zigbee2mqtt/bridge:notifications.failed_log_level"), 'error');
            });
        });
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // RESTART BRIDGE
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        $('#restart-bridge').off('click').on('click', function() {
            if (serverState.state !== 'online') {
                RED.notify(RED._("node-red-contrib-zigbee2mqtt/bridge:notifications.server_offline"), 'warning');
                return;
            }
            
            const currentServer = $('#node-input-server').val();
            
            if (confirm(RED._("node-red-contrib-zigbee2mqtt/bridge:label.sure_restart"))) {
                $.getJSON('zigbee2mqtt/restart', {
                    controllerID: currentServer
                }).done(function(data) {
                    RED.notify(RED._("node-red-contrib-zigbee2mqtt/bridge:notifications.restart_requested"), 'success');
                }).fail(function() {
                    RED.notify(RED._("node-red-contrib-zigbee2mqtt/bridge:notifications.failed_restart"), 'error');
                });
            }
        });
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // FUNÃ‡ÃƒO: Carregar Status
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function loadStatus() {
            const currentServer = $('#node-input-server').val();
            if (!currentServer) return;
            
            $('#status-devices-count').text(devicesData.length);
            $('#status-groups-count').text(groupsData.length);
            
            const isCached = serverState.state !== 'online';
            
            if (isCached) {
                if (serverState.zigbee2mqtt && serverState.zigbee2mqtt.coordinator) {
                    const coord = serverState.zigbee2mqtt.coordinator;
                    $('#status-coordinator').html(
                        coord.type + ' (' + (coord.meta?.revision || 'Unknown') + ') ' +
                        '<span style="color: #e65100; font-size: 11px;">(cached)</span>'
                    );
                } else {
                    $('#status-coordinator').html(
                        '<span class="status-error">âœ˜ ' + RED._("node-red-contrib-zigbee2mqtt/bridge:status.offline") + '</span>'
                    );
                }
                
                $('#status-advanced-output').html('<span class="status-error">âœ˜</span>');
                $('#status-legacy-api').html('<span class="status-error">âœ˜</span>');
                $('#status-mqtt-retain').html('<span class="status-error">âœ˜</span>');
                $('#status-permit-join').html('<span class="status-error">âœ˜</span>');
                $('#status-restart-required').html('<span class="status-error">âœ˜</span>');
                
                const logLevel = serverState.zigbee2mqtt?.log_level || 'Unknown';
                $('#status-log-level').html(
                    logLevel + ' <span style="color: #e65100; font-size: 11px;">(cached)</span>'
                );
                return;
            }
            
            $.getJSON('zigbee2mqtt/getConfig', {
                controllerID: currentServer,
                permit_join: true
            }).done(function(data) {
                if (!data || !data.coordinator) return;
                
                $('#status-coordinator').text(data.coordinator.type + ' (' + (data.coordinator.meta?.revision || 'Unknown') + ')');
                
                $('#status-advanced-output').html(
                    data.config?.advanced?.output !== 'json' ? 
                    '<span class="status-error">âœ˜ ' + RED._("node-red-contrib-zigbee2mqtt/bridge:label.should_be_json") + '</span>' : 
                    '<span class="status-ok">âœ” ' + RED._("node-red-contrib-zigbee2mqtt/bridge:label.ok") + '</span>'
                );
                
                $('#status-legacy-api').html(
                    data.config?.advanced?.legacy_api ? 
                    '<span class="status-error">âœ˜ ' + RED._("node-red-contrib-zigbee2mqtt/bridge:label.turn_off_legacy_api") + '</span>' : 
                    '<span class="status-ok">âœ” ' + RED._("node-red-contrib-zigbee2mqtt/bridge:label.ok") + '</span>'
                );
                
                $('#status-mqtt-retain').html(
                    data.config?.mqtt?.force_disable_retain ? 
                    '<span class="status-error">âœ˜ ' + RED._("node-red-contrib-zigbee2mqtt/bridge:label.retain_disabled_error") + '</span>' : 
                    '<span class="status-ok">âœ” ' + RED._("node-red-contrib-zigbee2mqtt/bridge:label.ok") + '</span>'
                );
                
                $('#status-permit-join').html(
                    data.permit_join ? 
                    '<span class="status-warning">âš  ' + RED._("node-red-contrib-zigbee2mqtt/bridge:label.permit_join") + '</span>' : 
                    '<span class="status-ok">âœ˜ Disabled</span>'
                );
                
                $('#status-restart-required').html(
                    data.restart_required ? 
                    '<span class="status-warning">âš  ' + RED._("node-red-contrib-zigbee2mqtt/bridge:label.restart_needed") + '</span>' : 
                    '<span class="status-ok">âœ˜ ' + RED._("node-red-contrib-zigbee2mqtt/bridge:label.not_required") + '</span>'
                );
                
                $('#status-log-level').text(data.log_level || 'info');
            }).fail(function() {
                if (serverState.zigbee2mqtt && serverState.zigbee2mqtt.coordinator) {
                    const coord = serverState.zigbee2mqtt.coordinator;
                    $('#status-coordinator').html(
                        coord.type + ' (' + (coord.meta?.revision || 'Unknown') + ') ' +
                        '<span style="color: #e65100; font-size: 11px;">(cached)</span>'
                    );
                } else {
                    $('#status-coordinator').html(
                        '<span class="status-error">âœ˜ ' + RED._("node-red-contrib-zigbee2mqtt/bridge:status.cannot_retrieve") + '</span>'
                    );
                }
            });
        }
        function sortTable(tableId, data, sortKey, sortOrder) {
            const sorted = [...data].sort((a, b) => {
                let valA, valB;
                
                if (sortKey === 'friendly_name') {
                    valA = a.friendly_name || '';
                    valB = b.friendly_name || '';
                } else if (sortKey === 'ieee_address') {
                    valA = a.ieee_address || '';
                    valB = b.ieee_address || '';
                } else if (sortKey === 'model') {
                    valA = a.definition?.model || 'Unknown';
                    valB = b.definition?.model || 'Unknown';
                } else if (sortKey === 'id') {
                    valA = a.id || 0;
                    valB = b.id || 0;
                }
                
                if (typeof valA === 'string') {
                    return sortOrder === 'asc' ? 
                        valA.localeCompare(valB) : 
                        valB.localeCompare(valA);
                } else {
                    return sortOrder === 'asc' ? valA - valB : valB - valA;
                }
            });
            
            return sorted;
        }
        
        function getDeviceStatusIcon(device) {
        if (serverState.state !== 'online') return '';
        
        if (device.disabled === true) {
            return '<span class="device-status-disabled" title="Device Disabled">âš«</span>';
        }
        
        if (device.availability && device.availability.toLowerCase() === 'offline') {
            return '<span class="device-status-offline" title="Device Offline">âŒ</span>';
        }
        
        if (device.interview_completed === false) {
            return `<span class="device-status-interview" 
                         title="Click to re-interview device" 
                         data-ieee="${device.ieee_address}"
                         style="cursor:pointer;">ğŸ”µ</span>`;
        }
        
        if (!device.definition || device.supported === false) {
            return '<span class="device-status-not-supported" title="Device Not Supported">ğŸ”¶</span>';
        }
        
        return '<span class="device-status-online" title="Device Online">âœ…</span>';
    }
                
        function getGroupStatusIcon(group) {
            if (serverState.state !== 'online') return '';
            
            if (!group.members || group.members.length === 0) {
                return '<span class="device-status-offline" title="No members in group">âŒ</span>';
            }
            
            let onlineCount = 0;
            let offlineCount = 0;
            
            group.members.forEach(function(member) {
                const device = devicesData.find(d => d.ieee_address === member.ieee_address);
                if (!device || device.availability === 'offline') {
                    offlineCount++;
                } else {
                    onlineCount++;
                }
            });
            
            if (offlineCount === group.members.length) {
                return '<span class="device-status-offline" title="All devices offline">âŒ</span>';
            } else if (onlineCount === group.members.length) {
                return '<span class="device-status-online" title="All devices online">âœ…</span>';
            } else {
                return `<span class="device-status-warning" title="${onlineCount}/${group.members.length} devices online">âš ï¸</span>`;
            }
        }  
    
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // FUNÃ‡ÃƒO: Carregar Devices
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function loadDevices(sortKey = 'friendly_name', sortOrder = 'asc') {
            const currentServer = $('#node-input-server').val();
            if (!currentServer) return;
            
            if (devicesData.length === 0) {
                $('#devices-status').html(
                    '<span class="status-warning">âš  ' + RED._("node-red-contrib-zigbee2mqtt/bridge:devices.no_devices_found") + '</span>'
                );
                $('#devices-table').hide();
                return;
            }
            
            if (serverState.state === 'online') {
                $('#devices-status').html(
                    '<span class="status-ok">âœ” ' + devicesData.length + ' ' + RED._("node-red-contrib-zigbee2mqtt/bridge:devices.devices_found") + '</span>'
                );
            } else {
                $('#devices-status').html(
                    '<span class="status-warning">âš  ' + RED._("node-red-contrib-zigbee2mqtt/bridge:notifications.server_offline_cached") + '</span>'
                );
            }
            
            renderDevicesTable(devicesData, sortKey, sortOrder);
        }
        
        function renderDevicesTable(devices, sortKey, sortOrder) {
            const sortedDevices = sortTable('devices', devices, sortKey, sortOrder);
            const currentServer = $('#node-input-server').val();
            
            $('#devices-table tbody').empty();
            
            sortedDevices.forEach(function(device) {
                const model = device.definition?.model || 'Unknown';
                const statusIcon = getDeviceStatusIcon(device);
                const input = `<input type="text" value="${device.friendly_name}" class="node-input-devices-friendly_name">`;
                const info = `<div><b>${device.ieee_address}</b></div>`;
                const modelCell = `<div>${model}</div>`;
                const saveBtn = `<a href="#" class="red-ui-button device-save-btn" data-ieee="${device.ieee_address}"><i class="fa fa-check"></i></a>`;
                const removeBtn = `<a href="#" class="red-ui-button device-remove-btn" data-ieee="${device.ieee_address}"><i class="fa fa-trash"></i></a>`;
                
                $('#devices-table tbody').append(
                    `<tr data-ieee="${device.ieee_address}">
                        <td class="status-col">${statusIcon}</td>
                        <td>${input}</td>
                        <td>${info}</td>
                        <td>${modelCell}</td>
                        <td>${saveBtn}</td>
                        <td>${removeBtn}</td>
                    </tr>`
                );
            });
            
            $('#devices-table th.sortable').removeClass('sorted-asc sorted-desc');
            $(`#devices-table th[data-sort="${sortKey}"]`).addClass(sortOrder === 'asc' ? 'sorted-asc' : 'sorted-desc');
            
            $('#devices-table').show();
            
            // DEVICE SAVE BUTTON
            $('.device-save-btn').off('click').on('click', function(e) {
                e.preventDefault();
                const ieee = $(this).data('ieee');
                const newName = $(this).closest('tr').find('.node-input-devices-friendly_name').val();
                
                $.getJSON('zigbee2mqtt/renameDevice', {
                    controllerID: currentServer,
                    ieee_address: ieee,
                    newName: newName
                }).done(function(data) {
                    if ("error" in data) {
                        alert(data.description);
                    } else {
                        RED.notify(RED._("node-red-contrib-zigbee2mqtt/bridge:notifications.device_renamed"), 'success');
                    }
                });
            });

            // DEVICE REMOVE BUTTON
            $('.device-remove-btn').off('click').on('click', function(e) {
                e.preventDefault();
                if (confirm(RED._("node-red-contrib-zigbee2mqtt/bridge:devices.sure_remove"))) {
                    const ieee = $(this).data('ieee');
                    
                    $.getJSON('zigbee2mqtt/removeDevice', {
                        controllerID: currentServer,
                        id: ieee
                    }).done(function(data) {
                        if ("error" in data) {
                            alert(data.description);
                        } else {
                            $(`tr[data-ieee="${ieee}"]`).remove();
                            RED.notify(RED._("node-red-contrib-zigbee2mqtt/bridge:notifications.device_removed"), 'success');
                        }
                    });
                }
            });
        }
        
        $('#devices-table').off('click', 'th.sortable').on('click', 'th.sortable', function() {
            const sortKey = $(this).data('sort');
            const currentOrder = $(this).hasClass('sorted-asc') ? 'desc' : 'asc';
            loadDevices(sortKey, currentOrder);
        });
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // FUNÃ‡ÃƒO: Carregar Groups
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function loadGroups(sortKey = 'friendly_name', sortOrder = 'asc') {
            const currentServer = $('#node-input-server').val();
            if (!currentServer) return;
            
            if (groupsData.length === 0) {
                $('#groups-status').html(
                    '<span class="status-warning">âš  ' + RED._("node-red-contrib-zigbee2mqtt/bridge:groups.no_groups_found") + '</span>'
                );
                $('#groups-table').hide();
                return;
            }
            
            if (serverState.state === 'online') {
                $('#groups-status').html(
                    '<span class="status-ok">âœ” ' + groupsData.length + ' ' + RED._("node-red-contrib-zigbee2mqtt/bridge:groups.groups_found") + '</span>'
                );
            } else {
                $('#groups-status').html(
                    '<span class="status-warning">âš  ' + RED._("node-red-contrib-zigbee2mqtt/bridge:notifications.server_offline_cached") + '</span>'
                );
            }
            
            renderGroupsTable(groupsData, devicesData, sortKey, sortOrder);
        }
        
        function renderGroupsTable(groups, devices, sortKey, sortOrder) {
            const sortedGroups = sortTable('groups', groups, sortKey, sortOrder);
            const devicesById = {};
            const currentServer = $('#node-input-server').val();
            
            devices.forEach(function(device) {
                devicesById[device.ieee_address + ''] = device;
            });
            
            $('#groups-table tbody').empty();
            
            sortedGroups.forEach(function(group) {
                const statusIcon = getGroupStatusIcon(group);
                const input = `<input type="text" value="${group.friendly_name}" class="node-input-groups-friendly_name">`;
                
                const tokeninputArr = devices.map(d => ({
                    id: d.ieee_address,
                    name: d.friendly_name,
                    model: d.definition?.model || 'Unknown'
                }));
                
                const tokeninputPrePopulate = group.members.map(m => ({
                    id: m.ieee_address,
                    name: devicesById[m.ieee_address + '']?.friendly_name || 'Unknown',
                    model: devicesById[m.ieee_address + '']?.definition?.model || 'Unknown'
                }));
                
                const saveBtn = `<a href="#" class="red-ui-button group-save-btn" data-id="${group.id}"><i class="fa fa-check"></i></a>`;
                const removeBtn = `<a href="#" class="red-ui-button group-remove-btn" data-id="${group.id}"><i class="fa fa-trash"></i></a>`;
                
                $('#groups-table tbody').append(
                    `<tr class="group-row-${group.id}">
                        <td class="status-col">${statusIcon}</td>
                        <td>${input}</td>
                        <td><input type="hidden" data-group_id="${group.id}" id="tokeninput_${group.id}" class="tokeninput"/></td>
                        <td>${saveBtn}</td>
                        <td>${removeBtn}</td>
                    </tr>`
                );
                
                $(`#tokeninput_${group.id}`).tokenInput(tokeninputArr, {
                    theme: 'facebook',
                    prePopulate: tokeninputPrePopulate,
                    processPrePopulate: true,
                    hintText: RED._("node-red-contrib-zigbee2mqtt/bridge:tokeninput.type_to_search"),
                    noResultsText: RED._("node-red-contrib-zigbee2mqtt/bridge:tokeninput.no_results"),
                    searchingText: RED._("node-red-contrib-zigbee2mqtt/bridge:tokeninput.searching"),
                    deleteText: '&times;',
                    animateDropdown: true,
                    resultsFormatter: function(item) {
                        return '<li>' + item.name + ' : ' + item.model + '</li>';
                    },
                    // ADD DEVICE TO GROUP
                    onAdd: function(item) {
                        const groupId = this.attr('data-group_id');
                        const deviceId = item.id;
                        
                        $.getJSON('zigbee2mqtt/addDeviceToGroup', {
                            controllerID: currentServer,
                            groupId: groupId,
                            deviceId: deviceId
                        }).done(function(data) {
                            if ("error" in data) {
                                alert(data.description);
                            } else {
                                RED.notify(RED._("node-red-contrib-zigbee2mqtt/bridge:notifications.device_added_to_group"), 'success');
                            }
                        });
                    },

                    // REMOVE DEVICE FROM GROUP
                    onDelete: function(item) {
                        const groupId = this.attr('data-group_id');
                        const deviceId = item.id;
                        
                        $.getJSON('zigbee2mqtt/removeDeviceFromGroup', {
                            controllerID: currentServer,
                            groupId: groupId,
                            deviceId: deviceId
                        }).done(function(data) {
                            if ("error" in data) {
                                alert(data.description);
                            } else {
                                RED.notify(RED._("node-red-contrib-zigbee2mqtt/bridge:notifications.device_removed_from_group"), 'success');
                            }
                        });
                    }
                });
            });
            
            $('#groups-table th.sortable').removeClass('sorted-asc sorted-desc');
            $(`#groups-table th[data-sort="${sortKey}"]`).addClass(sortOrder === 'asc' ? 'sorted-asc' : 'sorted-desc');
            
            $('#groups-table').show();
            
            // GROUP SAVE BUTTON
            $('.group-save-btn').off('click').on('click', function(e) {
                e.preventDefault();
                const id = $(this).data('id');
                const newName = $(this).closest('tr').find('.node-input-groups-friendly_name').val();
                
                $.getJSON('zigbee2mqtt/renameGroup', {
                    controllerID: currentServer,
                    id: id,
                    newName: newName
                }).done(function(data) {
                    if ("error" in data) {
                        alert(data.description);
                    } else {
                        RED.notify(RED._("node-red-contrib-zigbee2mqtt/bridge:notifications.group_renamed"), 'success');
                    }
                });
            });

            // GROUP REMOVE BUTTON
            $('.group-remove-btn').off('click').on('click', function(e) {
                e.preventDefault();
                if (confirm(RED._("node-red-contrib-zigbee2mqtt/bridge:groups.sure_remove"))) {
                    const id = $(this).data('id');
                    
                    $.getJSON('zigbee2mqtt/removeGroup', {
                        controllerID: currentServer,
                        id: id
                    }).done(function(data) {
                        if ("error" in data) {
                            alert(data.description);
                        } else {
                            $(`.group-row-${id}`).remove();
                            RED.notify(RED._("node-red-contrib-zigbee2mqtt/bridge:notifications.group_removed"), 'success');
                        }
                    });
                }
            });
        }
        
        $('#groups-table').off('click', 'th.sortable').on('click', 'th.sortable', function() {
            const sortKey = $(this).data('sort');
            const currentOrder = $(this).hasClass('sorted-asc') ? 'desc' : 'asc';
            loadGroups(sortKey, currentOrder);
        });
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // ADD GROUP
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        $('#add-group-btn').off('click').on('click', function(e) {
            e.preventDefault();
            
            if (serverState.state !== 'online') {
                RED.notify(RED._("node-red-contrib-zigbee2mqtt/bridge:notifications.server_offline"), 'warning');
                return;
            }
            
            const currentServer = $('#node-input-server').val();
            const name = prompt(RED._("node-red-contrib-zigbee2mqtt/bridge:groups.enter_group_name"), "");
            
            if (name) {
                $.getJSON('zigbee2mqtt/addGroup', {
                    controllerID: currentServer,
                    name: name
                }).done(function(data) {
                    if ("error" in data) {
                        alert(data.description);
                    } else {
                        RED.notify(RED._("node-red-contrib-zigbee2mqtt/bridge:notifications.group_added"), 'success');
                        setTimeout(function() {
                            init();
                        }, 1000);
                    }
                }).fail(function() {
                    RED.notify(RED._("node-red-contrib-zigbee2mqtt/bridge:notifications.failed_add_group"), 'error');
                });
            }
        });
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // MAP
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // REFRESH MAP
        $('#refresh-map-btn').off('click').on('click', function(e) {
            e.preventDefault();
            
            if (serverState.state !== 'online') {
                RED.notify(RED._("node-red-contrib-zigbee2mqtt/bridge:notifications.server_offline"), 'warning');
                return;
            }
            
            const currentServer = $('#node-input-server').val();
            const $btn = $(this);
            
            $('#map-display').html('');
            $btn.find('.fa-refresh').addClass('fa-spin');
            $btn.find('span').text(RED._("node-red-contrib-zigbee2mqtt/bridge:map.loading"));
            $('#fullscreen-map-btn').hide();
            
            $.getJSON('zigbee2mqtt/refreshMap', {
                controllerID: currentServer,
                engine: $('#node-input-engine').val()
            }).done(function(data) {
                $btn.find('.fa-refresh').removeClass('fa-spin');
                $btn.find('span').text(RED._("node-red-contrib-zigbee2mqtt/bridge:map.refresh"));
                $('#fullscreen-map-btn').show();
                $('#map-display').html(data.svg).find('svg').attr('width', '100%').attr('height', '100%');
                RED.notify(RED._("node-red-contrib-zigbee2mqtt/bridge:notifications.map_refreshed"), 'success');
                
                hasMapData = true;
                updateUIState();
            }).fail(function() {
                $btn.find('.fa-refresh').removeClass('fa-spin');
                $btn.find('span').text(RED._("node-red-contrib-zigbee2mqtt/bridge:map.refresh"));
                $('#map-display').html(
                    '<span class="status-error">âœ˜ ' + RED._("node-red-contrib-zigbee2mqtt/bridge:map.failed_to_load") + '</span>'
                );
                RED.notify(RED._("node-red-contrib-zigbee2mqtt/bridge:notifications.failed_refresh_map"), 'error');
                
                hasMapData = false;
                updateUIState();
            });
        });

        // FULLSCREEN MAP
        $('#fullscreen-map-btn').off('click').on('click', function(e) {
            e.preventDefault();
            
            const svgContent = $('#map-display').html();
            
            if (!svgContent || svgContent.trim() === '') {
                RED.notify(RED._("node-red-contrib-zigbee2mqtt/bridge:map.no_map_data"), 'warning');
                return;
            }
            
            const $overlay = $('<div>')
                .css({
                    position: 'fixed',
                    top: 0,
                    left: 0,
                    right: 0,
                    bottom: 0,
                    backgroundColor: 'rgba(0,0,0,0.95)',
                    zIndex: 10000,
                    display: 'flex',
                    flexDirection: 'column',
                    alignItems: 'center',
                    justifyContent: 'center',
                    padding: '20px'
                });
            
            const $closeBtn = $('<button>')
                .html('<i class="fa fa-times"></i> ' + RED._("node-red-contrib-zigbee2mqtt/bridge:map.fullscreen"))
                .css({
                    position: 'absolute',
                    top: '20px',
                    right: '20px',
                    padding: '10px 20px',
                    backgroundColor: '#c62828',
                    color: 'white',
                    border: 'none',
                    borderRadius: '4px',
                    cursor: 'pointer',
                    fontSize: '14px',
                    fontWeight: 'bold',
                    zIndex: 10001
                })
                .on('click', function() {
                    $overlay.remove();
                    $(document).off('keydown.mapfullscreen');
                })
                .on('mouseenter', function() {
                    $(this).css('backgroundColor', '#b71c1c');
                })
                .on('mouseleave', function() {
                    $(this).css('backgroundColor', '#c62828');
                });
            
            const $mapContainer = $('<div>')
                .html(svgContent)
                .css({
                    width: '95%',
                    height: '95%',
                    backgroundColor: 'white',
                    borderRadius: '8px',
                    padding: '20px',
                    overflow: 'auto',
                    boxShadow: '0 4px 20px rgba(0,0,0,0.5)'
                });
            
            $mapContainer.find('svg').attr('width', '100%').attr('height', '100%');
            
            $overlay.append($closeBtn).append($mapContainer);
            $('body').append($overlay);
            
            $(document).on('keydown.mapfullscreen', function(e) {
                if (e.key === 'Escape') {
                    $overlay.remove();
                    $(document).off('keydown.mapfullscreen');
                }
            });
        });
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // INICIALIZAÃ‡ÃƒO ÃšNICA
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       if (node.server && node.server !== '_ADD_' && node.server !== '') {
            setTimeout(function() {
                init();
                startStateMonitoring(); // âœ… INICIAR MONITORAMENTO
            }, 100);
        } else {
            serverState = {
                online: false,
                state: 'not_configured',
                errorComponent: null
            };
            clearAllTables();
            updateUIState();
        }
    },

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // oneditsave
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    oneditsave: function() {
        this.permitjoin_time = parseInt($('#node-input-permitjoin-time').val()) || 180;
        
        // âœ… Parar monitoramento ao salvar
        if (this._z2m_stateCheckInterval) {
            console.log('[Z2M] ğŸ›‘ Cleanup: Stopping monitoring on SAVE');
            clearInterval(this._z2m_stateCheckInterval);
            this._z2m_stateCheckInterval = null;
        }
    },

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // oneditcancel
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•    
    oneditcancel: function() {
        // âœ… Parar monitoramento ao cancelar
        if (this._z2m_stateCheckInterval) {
            console.log('[Z2M] ğŸ›‘ Cleanup: Stopping monitoring on CANCEL');
            clearInterval(this._z2m_stateCheckInterval);
            this._z2m_stateCheckInterval = null;
        }
    }
});
</script>
