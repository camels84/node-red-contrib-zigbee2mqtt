<script type="text/x-red" data-template-name="zigbee2mqtt-out">
    <link rel="stylesheet" href="resources/node-red-contrib-zigbee2mqtt/css/multiple-select.css" type="text/css" />
    <link rel="stylesheet" href="resources/node-red-contrib-zigbee2mqtt/css/common.css" type="text/css" />

    <div class="form-row">
        <label for="node-input-name" class="l-width"><i class="fa fa-bookmark"></i> <span data-i18n="label.name"></span></label>
        <input type="text" id="node-input-name" data-i18n="[placeholder]placeholder.name">
    </div>
   <div class="form-row" style="display:none;">
        <label for="node-input-friendly_name" class="l-width"><i class="fa fa-bookmark"></i> <span data-i18n="label.friendly_name"></span></label>
        <input type="text" id="node-input-friendly_name" data-i18n="[placeholder]placeholder.friendly_name">
    </div>
    <div class="form-row">
        <label for="node-input-server" class="l-width"><i class="fa fa-globe"></i> <span data-i18n="label.server"></span></label>
        <input type="text" id="node-input-server">
    </div>
    <div class="form-row">
        <label for="node-input-device_id" class="l-width"><i class="fa fa-crosshairs"></i> <span data-i18n="label.topic"></span></label>
        <select id="node-input-device_id" class="s-width" multiple="multiple"></select>
    </div>
<!--    <div class="form-row">-->
<!--        <label for='node-input-enableMultiple' class="l-width"></label>-->
<!--        <input type="checkbox" id="node-input-enableMultiple" style="display: inline-block; width: auto; vertical-align: top;"> <span data-i18n="node-red-contrib-spruthub/server:label.enable_multiple"></span></input>-->
<!--    </div>-->
    <div class="form-row">
        <label for="force-refresh" class="l-width"><i class="fa fa-refresh"></i> <span data-i18n="label.refresh"></span></label>
        <a class="red-ui-button s-width" id="force-refresh" name="force-refresh"><span data-i18n="label.refresh_devices_list"></span></a>
    </div>
    <div class="form-row">
        <label for="node-input-command" class="l-width"><i class="fa fa-tasks"></i> <span data-i18n="label.command"></span></label>
        <input type="text" id="node-input-command" style="width:70%">
        <input type="hidden" id="node-input-commandType">
    </div>
	<div class="form-row">
        <label for="node-input-payload" class="l-width"><i class="fa fa-envelope"></i> <span data-i18n="label.payload"></span></label>
        <input type="text" id="node-input-payload" style="width:70%">
        <input type="hidden" id="node-input-payloadType">
    </div>

    <!--homekit-->
    <div class="form-row help_block help_block__homekit_homekit">
        <div class="form-tips">
            <strong><span data-i18n="help.important"></span></strong><br>
            <span data-i18n="help.command_homekit"></span>
        </div>
    </div>

	<div class="form-row">
        <label for="node-input-optionsValue" class="l-width"><i class="fa fa-gears"></i> <span data-i18n="label.options"></span></label>
        <input type="text" id="node-input-optionsValue" style="width:70%">
        <input type="hidden" id="node-input-optionsType">
    </div>
    <!--option description-->
    <div class="form-tips optionsType_description">
        <strong><div data-i18n="help.description"></div></strong>
        <span></span>
    </div>

    <div class="form-row node-input-rule-container-row">
        <ol id="node-input-rule-container"></ol>
    </div>
    <hr>


    <!--brightness_move-->
    <div class="form-tips help_block help_block__z2m_cmd_brightness_move">
        <strong><span data-i18n="help.description"></span></strong><br>
        <span data-i18n="help.command_brightness_move"></span>
    </div>
    <!--brightness_step-->
    <div class="form-tips help_block help_block__z2m_cmd_brightness_step">
        <strong><span data-i18n="help.description"></span></strong><br>
        <span data-i18n="help.command_brightness_step"></span>
    </div>

</script>

<script type="text/javascript">
RED.nodes.registerType('zigbee2mqtt-out', {
    category: 'zigbee2mqtt',
    color: '#E2D96E',
    defaults: {
        device: { value: "" },
        attribute: { value: "" },
        name: { value: "" }
    },
    inputs: 1,
    outputs: 0,
    icon: "bridge.svg",
    label: function() {
        return this.name || this.device || "zigbee2mqtt out";
    },
    oneditprepare: function() {
        const deviceSelect = $("#node-input-device");
        const attributeSelect = $("#node-input-attribute");

        function loadDeviceList() {
            $.getJSON('zigbee2mqtt/devices', function(devices) {
                deviceSelect.empty();
                devices.forEach(function(dev) {
                    deviceSelect.append(
                        $('<option></option>').val(dev.friendly_name).text(dev.friendly_name)
                    );
                });

                // se já havia valor guardado, recarregar os atributos
                const savedDevice = deviceSelect.val() || $("#node-input-device").val();
                if (savedDevice) {
                    loadAttributes(savedDevice);
                }
            });
        }

        function loadAttributes(deviceName) {
            $.getJSON('zigbee2mqtt/devices', function(devices) {
                const dev = devices.find(d => d.friendly_name === deviceName);
                attributeSelect.empty();
                if (dev && dev.definition && dev.definition.exposes) {
                    dev.definition.exposes.forEach(exp => {
                        // campos simples
                        if (exp.name) {
                            attributeSelect.append(
                                $('<option></option>').val(exp.name).text(exp.name)
                            );
                        }
                        // se o expose tiver múltiplos features (como switches com canais)
                        if (exp.features) {
                            exp.features.forEach(f => {
                                attributeSelect.append(
                                    $('<option></option>').val(f.name).text(f.name)
                                );
                            });
                        }
                    });
                }
            });
        }

        deviceSelect.on('change', function() {
            const selectedDevice = $(this).val();
            loadAttributes(selectedDevice);
        });

        loadDeviceList();
    }
});
</script>


