<script type='text/javascript'>
    $.getScript('resources/node-red-contrib-zigbee2mqtt/tokeninput/jquery.tokeninput.js');
</script>
<script type="text/x-red" data-template-name="zigbee2mqtt-out">
        <link rel="stylesheet" href="resources/node-red-contrib-zigbee2mqtt/css/multiple-select.css" type="text/css" />
        <link rel="stylesheet" href="resources/node-red-contrib-zigbee2mqtt/css/common.css" type="text/css" />

        <div class="form-row">
            <label for="node-input-name" class="l-width"><i class="fa fa-bookmark"></i> <span data-i18n="label.name"></span></label>
            <input type="text" id="node-input-name" data-i18n="[placeholder]placeholder.name">
        </div>
        <!-- Node Name Input -->        
       <div class="form-row" style="display:none;">
            <label for="node-input-friendly_name" class="l-width"><i class="fa fa-bookmark"></i> <span data-i18n="label.friendly_name"></span></label>
            <input type="text" id="node-input-friendly_name" data-i18n="[placeholder]placeholder.friendly_name">
        </div>
        <!-- Server Input -->
        <div class="form-row">
            <label for="node-input-server" class="l-width"><i class="fa fa-globe"></i> <span data-i18n="label.server"></span></label>
            <input type="text" id="node-input-server">
        </div>
        <!-- Device Input -->
        <div class="form-row">
            <label for="node-input-device_id" class="l-width"><i class="fa fa-crosshairs"></i> <span data-i18n="label.topic"></span></label>
            <select id="node-input-device_id" class="s-width" ></select>
        </div>
        <!-- Refresh Device Button -->        
        <div class="form-row">
            <label for="force-refresh" class="l-width"><i class="fa fa-refresh"></i> <span data-i18n="label.refresh"></span></label>
            <a class="red-ui-button s-width" id="force-refresh" name="force-refresh"><span data-i18n="label.refresh_devices_list"></span></a>
        </div>
        <!-- Command Input -->
        <div class="form-row">
            <label for="node-input-command" class="l-width"><i class="fa fa-tasks"></i> <span data-i18n="label.command"></span></label>
            <!-- Select oculto para armazenar comandos do device -->
            <select id="node-input-command-list" style="display:none"></select>
            <!-- Input visivel com typedInput -->
            <input type="text" id="node-input-command" style="width:70%">
            <input type="hidden" id="node-input-commandType">
        </div>
        
         <!-- ============================================================================ -->
        <!-- ðŸŽ¨ LAYOUT INLINE - Checkbox ao lado direito do Payload                        -->
        <!-- ============================================================================ -->
        
        <!-- ============================================================================ -->
        <!-- ðŸŽ¨ LAYOUT: Payload + Manual Controls Container                               -->
        <!-- ============================================================================ -->
        <!-- 1. Row do Payload + Checkbox -->
        <div class="form-row" id="payload-row">
            <label for="node-input-payload" class="l-width">
                <i class="fa fa-envelope"></i> <span data-i18n="label.payload"></span>
            </label>
            
            <div style="display: inline-flex; align-items: center; width: 70%; gap: 5px;">
                <div style="flex: 1; min-width: 0;">
                    <input type="text" id="node-input-payload" style="width: 100%;">
                    <input type="hidden" id="node-input-payloadType">
                </div>
                
                <div id="slider-visibility-inline" style="display: none; flex-shrink: 0; margin-left: 5px;" title="Show Manual Controls">
                    <label style="margin: 0; cursor: pointer; width: auto;">
                        <input type="checkbox" 
                               id="node-input-manualPayloadSliderVisible" 
                               style="vertical-align: middle; margin: 0 4px 0 0; width: auto;">
                        <i class="fa fa-sliders" style="color: #555; font-size: 14px; vertical-align: middle;"></i>
                    </label>
                </div>
            </div>
        </div>

        <!-- 2. Contentor Principal dos Controlos Manuais -->
        <div id="z2m-manual-controls-container" style="display:none;">
            
            <!-- WRAPPER 1: Caixas de Valor (Inputs) -->
             <div id="z2m-inputs-wrapper" class="form-row">
                 <!-- Injetado via JS -->
            </div>
 
            <!-- WRAPPER 2: Sliders (Ranges) -->
             <div id="z2m-sliders-wrapper">
                 <!-- Injetado via JS -->
            </div>
        </div>
   
        <!-- Homekit help -->
        <div class="form-row help_block help_block__homekit_homekit">
            <div class="form-tips">
                <strong><span data-i18n="help.important"></span></strong><br>
                <span data-i18n="help.command_homekit"></span>
            </div>
        </div>

        <div class="form-row">
            <label for="node-input-optionsValue" class="l-width"><i class="fa fa-gears"></i> <span data-i18n="label.options"></span></label>
            <input type="text" id="node-input-optionsValue" style="width:70%">
            <input type="hidden" id="node-input-optionsType">
        </div>
        <!--option description-->
        <div class="form-tips optionsType_description">
            <strong><div data-i18n="help.description"></div></strong>
            <span></span>
        </div>

        <div class="form-row node-input-rule-container-row">
            <ol id="node-input-rule-container"></ol>
        </div>
        <hr>


        <!--brightness_move-->
        <div class="form-tips help_block help_block__z2m_cmd_brightness_move">
            <strong><span data-i18n="help.description"></span></strong><br>
            <span data-i18n="help.command_brightness_move"></span>
        </div>
        <!--brightness_step-->
        <div class="form-tips help_block help_block__z2m_cmd_brightness_step">
            <strong><span data-i18n="help.description"></span></strong><br>
            <span data-i18n="help.command_brightness_step"></span>
        </div>

    </script>
    <script type="text/javascript">
        RED.nodes.registerType('zigbee2mqtt-out', {
            category: 'Zigbee2mqtt',
            color: '#FDBF48',
            align: 'right',
            defaults: {
                name: {
                    value: ""
                },
                server: {
                    type: "zigbee2mqtt-server",
                    required: true
                },
                friendly_name: {
                    value: "",
                    required: false
                },
                device_id: {
                    value: null
                },
                command: {
                    value: ' ',
                },
                commandType: {
                    value: 'z2m_cmd',
                },
                payload: {
                    value: ' ',
                },
                payloadType: {
                    value: 'msg',
                },
                optionsValue: {
                    value: null,
                },
                optionsType: {
                    value: null,
                },
                manualPayloadSliderVisible: {
                    value: true,
                }
            },
            inputLabels: "value",
            paletteLabel: 'out',
            inputs: 1,
            outputs: 0,
            icon: "icon.png",
            label: function() {
                var label = 'z2m-out';

                if (this.name) {
                    label = this.name;
                } else if (typeof(this.friendly_name) == 'string' && this.friendly_name.length) {
                    label = this.friendly_name;
                } else if (typeof(this.device_id) == 'string') {
                    label = this.device_id;
                }
                return label;
            },
            oneditprepare: function() {
                let node = this;
                const d = (typeof Z2MDebug !== 'undefined') ? Z2MDebug.create('Z2M Out') : console;
                node.z2mDebug = d;
                
                d.log('ðŸš€ oneditprepare STARTING (v3.7 Safe Entry)');
                
                function showHelpBlock() {
                    var $inputCommand = $('#node-input-command');
                    var command = $inputCommand.val();
                    var commandType = $('#node-input-commandType').val();
                    var cmd = (command === '{}') ? 'json' : command;
                    var type = (commandType === 'str') ? 'custom' : commandType;
                    $('.help_block').hide();
                    $('.help_block__' + type + '_' + cmd).show();
                }
 
                node.z2mEditor = new Zigbee2MqttEditor(node, { 'allow_empty': false, 'mode': 'out' });
                
                setTimeout(() => {
                    node.z2mEditor.build().then(() => {
                        d.log('âœ… Editor build complete');
                        showHelpBlock();
                    });
                }, 100);
            },            
            oneditsave: function() {
                let node = this;
                const d = (typeof Z2MDebug !== 'undefined') ? Z2MDebug.create('Z2M Save') : console;
                if (node.z2mEditor) 
                    { node.z2mEditor.initializing = false; }
    
                // 1. Device ID e Topic
                const device_id = $('#node-input-device_id').multipleSelect('getSelects', 'value');
                node.device_id = device_id && device_id.length ? device_id[0] : null;
                const selected = $('#node-input-device_id option:selected');
                node.topic = (selected && selected.length) ? selected.map(function(){return $(this).val();}).get() : null;
                node.friendly_name = selected.first().data('friendly_name') || null;
 
                // 2. Command TypedInput
                const $cmd = $('#node-input-command');
                if ($cmd.data('typedInput') || $cmd.parent().hasClass('red-ui-typedInput-container')) {
                    try {
                        node.commandType = $cmd.typedInput('type');
                        const v = $cmd.typedInput('value');
                        node.command = (v && typeof v === 'object') ? v.value : v;
                    } catch(e) { console.error('Save Cmd Err:', e); }
                }
 
                // 3. Payload TypedInput
                const $pay = $('#node-input-payload');
                if ($pay.data('typedInput') || $pay.parent().hasClass('red-ui-typedInput-container')) {
                    try {
                        node.payloadType = $pay.typedInput('type');
                        let pVal = $pay.typedInput('value');
                        // Extrair valor de objectos de opÃ§Ã£o do TypedInput
                         if (pVal === null || pVal === undefined) pVal = $pay.val();
                        node.payload = (pVal && typeof pVal === 'object' && pVal.value !== undefined) ? pVal.value : pVal;
                    } catch(e) { console.error('Save Pay Err:', e); }
                }
 
                // 4. Options TypedInput
                const $opt = $('#node-input-optionsValue');
                if ($opt.data('typedInput') || $opt.parent().hasClass('red-ui-typedInput-container')) {
                    try {
                        node.optionsType = $opt.typedInput('type');
                        node.optionsValue = $opt.typedInput('value');
                    } catch(e) { console.error('Save Opt Err:', e); }
                }
                
                // 5. Checkbox Manual Slider
                node.manualPayloadSliderVisible = $('#node-input-manualPayloadSliderVisible').is(':checked');
                
                if (d && d.log) 
                    d.log('Saved Node State:', node.command, node.payload);
                return true;
            }

    });
    </script>